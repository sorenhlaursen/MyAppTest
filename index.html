<!DOCTYPE html>
<html>
  <head>
    <title>Spongy</title>

    <script type="text/javascript" charset="utf-8" src="cordova.js"></script>
    <script type="text/javascript" charset="utf-8" src="js/functions.js"></script>
    <script type="text/javascript" charset="utf-8" src="js/html5sql.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js" ></script>
    
    
	<script type="text/javascript" charset="utf-8">
	//prepare variables for geo-data
	var geoLatitude;
	var geoLongitude;
	var geoAltitude;
	var geoAccuracy;
	var geoAltitudeAccuracy;
	var geoHeading;
	var geoSpeed;
	var geoTimestamp;
	
    // Wait for Cordova to load
    //
    document.addEventListener("deviceready", onDeviceReady, false);

    // Cordova is ready
    //
    function onDeviceReady() {
		window.setInterval(function(){
			navigator.geolocation.getCurrentPosition(onGeoSuccess, onGeoError);
		}, 500);
		var status = document.getElementById('status');
    }
    
		function reBuildDB()
		{
			var output = document.getElementById('output');
			output.innerHTML = 'Building DB...';
		
		html5sql.openDatabase("com.zocializr.SpongyDB", "Spongy Database", 3*1024*1024);
				
		html5sql.process(
		     [
		         "DROP TABLE IF EXISTS myPosition;",
				 "CREATE TABLE IF NOT EXISTS myPosition (userID INTEGER, geoLatitude FLOAT, geoLongitude FLOAT, geoAltitude FLOAT, geoAccuracy INTEGER, timestampLocal INTEGER, timestampServer INTEGER, geoNote TEXT, shareWithFriends INTEGER, shareWithPublic INTEGER, UNIQUE(userID,timestampLocal));",
			     "INSERT INTO myPosition (userID, geoLatitude, geoLongitude) VALUES (1,55.64766889443216,12.27746374900625);", 
			     "INSERT INTO myPosition (userID, geoLatitude, geoLongitude) VALUES (2,15.64766889443216,43.27746374900625);", 
			     "INSERT INTO myPosition (userID, geoLatitude, geoLongitude) VALUES (3,52.64766889443216,54.27746374900625);", 
			     "INSERT INTO myPosition (userID, geoLatitude, geoLongitude) VALUES (4,34.64766889443216,65.27746374900625);", 
			     "INSERT INTO myPosition (userID, geoLatitude, geoLongitude) VALUES (1,76.64766889443216,76.27746374900625);"
		     ],
		     function(){
				status.innerHTML = "Success creating and inserting into Tables";
		        testDB();
		     },
		     function(error, statement){
		        status.innerHTML = "Error: " + error.message + " when processing " + statement;
		     }
		 );		
    	}

		// FETCH SQL-RESULTS
		function testDB(){
			html5sql.process(
			    ["SELECT * FROM myPosition;"],
			    function(transaction, results, rowsArray){
			    	var outputRows = '';
			      	for(var i = 0; i < rowsArray.length; i++){
			        	//each row in the rowsArray represents a row retrieved from the database
			        	var data = rowsArray[i].data;
			        	outputRows = outputRows +data+ '<br/>';
			      	}
					var output = document.getElementById('output');
			      	output.innerHTML = outputRows;

			    },
			    function(error, statement){
			      //hande error here           
			    }
			);		
		}


    // onSuccess Geolocation
    //
    function onGeoSuccess(position) {
		//Save current position and data
		geoLatitude = position.coords.latitude;
		geoLongitude = position.coords.longitude;
		geoAltitude = position.coords.altitude
		geoAccuracy = position.coords.accuracy;
		geoAltitudeAccuracy = position.coords.altitudeAccuracy;
		geoHeading = position.coords.heading;
		geoSpeed = position.coords.speed;
		geoTimestamp = position.timestamp;
		reportGeoPosition();
    }

    // onError Callback receives a PositionError object
    //
    function onGeoError(error) {
        alert('code: '    + error.code    + '\n' +
              'message: ' + error.message + '\n');
    }
	
	function reportGeoPosition(){
		//post_to_url('http://my.spongy.dk/save_position.php',{'lat':geoLatitude,'long':'432','accu':'2','timestamp':'12.12.12 43:23'});
        var element = document.getElementById('geoData');
        element.innerHTML = 'Latitude: '           + geoLatitude            + '<br />' +
                            'Longitude: '          + geoLongitude           + '<br />' +
                            'Altitude: '           + geoAltitude            + '<br />' +
                            'Accuracy: '           + geoAccuracy            + '<br />' +
                            'Altitude Accuracy: '  + geoAltitudeAccuracy    + '<br />' +
                            'Heading: '            + geoHeading             + '<br />' +
                            'Speed: '              + geoSpeed               + '<br />' +
                            'Timestamp: '          + geoTimestamp			+ '<br />';
		
	}	
	</script>    
  </head>
  <body>
	<p><a href="#" onclick="reportGeoPosition();" style="padding:5px;background:#808080;">Report position</a></p>
	<div id="geoData"></div>
	<div><hr></div>
	<div id="output">No Database</div>
	<div><a href="#" onclick="reBuildDB();" style="padding:10px 20px;background:#80000">Rebuild DB</a></div>
	<div id="status"></div>

  </body>
</html>
